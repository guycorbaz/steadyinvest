name: E2E Tests

on:
  push:
    branches:
      - master
      - main
  pull_request:

env:
  RUST_TOOLCHAIN: stable
  HEADLESS: "true"
  BASE_URL: "http://localhost:5173"
  CHROME_DRIVER_URL: "http://localhost:9515"

jobs:
  unit-tests:
    name: Build & Unit Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      DATABASE_URL: mysql://steadyinvest:steadyinvest_test@localhost:3306/steadyinvest_test

    services:
      mariadb:
        image: mariadb:11
        env:
          MARIADB_ROOT_PASSWORD: test
          MARIADB_DATABASE: steadyinvest_test
          MARIADB_USER: steadyinvest
          MARIADB_PASSWORD: steadyinvest_test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "healthcheck.sh --connect --innodb_initialized"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run unit and integration tests
        run: cargo test --workspace --exclude e2e-tests

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    permissions:
      contents: read

    env:
      DATABASE_URL: mysql://steadyinvest:steadyinvest_test@localhost:3306/steadyinvest_test

    services:
      mariadb:
        image: mariadb:11
        env:
          MARIADB_ROOT_PASSWORD: test
          MARIADB_DATABASE: steadyinvest_test
          MARIADB_USER: steadyinvest
          MARIADB_PASSWORD: steadyinvest_test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "healthcheck.sh --connect --innodb_initialized"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: wasm32-unknown-unknown

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-chromedriver: true

      - name: Start ChromeDriver
        run: |
          chromedriver --port=9515 &
          sleep 2

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install trunk
        run: cargo binstall trunk --no-confirm

      - name: Build backend
        run: cargo build -p backend

      - name: Build frontend
        run: |
          cd frontend
          trunk build

      - name: Start backend server
        run: |
          cargo run -p backend -- start -e test > backend.log 2>&1 &

      - name: Wait for backend readiness
        run: |
          echo "Waiting for backend to start..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:5150/api/v1/system/health > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "ERROR: Backend failed to start within 60 seconds"
              cat backend.log
              exit 1
            fi
            sleep 2
          done

      - name: Start frontend SPA server
        run: |
          cd frontend
          python3 -c "
          import http.server, functools, pathlib
          class H(http.server.SimpleHTTPRequestHandler):
              def do_GET(self):
                  if not pathlib.Path(self.translate_path(self.path)).exists():
                      self.path = '/index.html'
                  super().do_GET()
          http.server.HTTPServer(('', 5173), functools.partial(H, directory='dist')).serve_forever()
          " &

      - name: Wait for frontend readiness
        run: |
          echo "Waiting for frontend to start..."
          for i in $(seq 1 10); do
            if curl -sf http://localhost:5173 > /dev/null 2>&1; then
              echo "Frontend is ready!"
              break
            fi
            if [ "$i" -eq 10 ]; then
              echo "ERROR: Frontend failed to start within 20 seconds"
              exit 1
            fi
            sleep 2
          done

      - name: Create screenshots directory
        run: mkdir -p screenshots

      - name: Run E2E tests
        run: cargo test -p e2e-tests -- --test-threads=1 --nocapture

      - name: Upload failure artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug-artifacts
          path: |
            screenshots/
            backend.log
          if-no-files-found: ignore
          retention-days: 7
