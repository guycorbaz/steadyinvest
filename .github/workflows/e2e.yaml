name: E2E Tests

on:
  push:
    branches:
      - master
      - main
  pull_request:

env:
  RUST_TOOLCHAIN: stable
  HEADLESS: "true"
  BASE_URL: "http://localhost:5173"
  CHROME_DRIVER_URL: "http://localhost:9515"

jobs:
  unit-tests:
    name: Build & Unit Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    services:
      mariadb:
        image: mariadb:11
        env:
          MARIADB_ROOT_PASSWORD: test
          MARIADB_DATABASE: naic_test
          MARIADB_USER: naic
          MARIADB_PASSWORD: naic_test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "healthcheck.sh --connect --innodb_initialized"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run unit and integration tests
        run: cargo test --workspace --exclude e2e-tests
        env:
          DATABASE_URL: mysql://naic:naic_test@localhost:3306/naic_test

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    permissions:
      contents: read

    services:
      mariadb:
        image: mariadb:11
        env:
          MARIADB_ROOT_PASSWORD: test
          MARIADB_DATABASE: naic_test
          MARIADB_USER: naic
          MARIADB_PASSWORD: naic_test
        ports:
          - "3306:3306"
        options: >-
          --health-cmd "healthcheck.sh --connect --innodb_initialized"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Start ChromeDriver
        run: |
          chromedriver --port=9515 &
          sleep 2

      - name: Install trunk (frontend build tool)
        run: cargo install trunk

      - name: Build workspace
        run: cargo build --all

      - name: Start backend server
        run: |
          cargo run -p backend &
          sleep 5
        env:
          DATABASE_URL: mysql://naic:naic_test@localhost:3306/naic_test

      - name: Build and serve frontend
        run: |
          cd frontend
          trunk build
          # Serve the built files on port 5173
          python3 -m http.server 5173 --directory dist &
          sleep 2

      - name: Run E2E tests
        run: cargo test -p e2e-tests -- --test-threads=1
        env:
          HEADLESS: "true"
          BASE_URL: "http://localhost:5173"
          CHROME_DRIVER_URL: "http://localhost:9515"
