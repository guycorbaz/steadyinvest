# Epic 7 Retrospective — Analysis Persistence & MVP Fixes

**Date:** 2026-02-15
**Facilitator:** Bob (Scrum Master)
**Participants:** Guy (Project Lead), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

---

## Epic 7 Summary

- **Stories:** 7/7 completed (100%)
- **Scope:** Backend infrastructure — schema migration, snapshot API, exchange rate service, chart capture, library view, CI/CD validation
- **Character:** Backend/infrastructure-heavy epic with minimal UI changes

### Stories Delivered

| Story | Title | Status |
|-------|-------|--------|
| 7.1 | MVP Fixes — PDF Export, Chart Height & Legend | Done |
| 7.2 | Pre-Migration Backup & Snapshot Schema | Done |
| 7.3 | Analysis Snapshot API | Done |
| 7.4 | Static Chart Image Capture at Lock Time | Done |
| 7.5 | Exchange Rate Service | Done |
| 7.6 | Library View & Analysis Browsing | Done |
| 7.7 | CI/CD E2E Pipeline Validation | Done |

---

## Epic 6 Retro Follow-Through

| # | Action Item | Status |
|---|-------------|--------|
| 1 | Strengthen DoD — UI Accessibility Check | ✅ Applied (Story 7.1) |
| 2 | Maintain Adversarial Code Review Process | ✅ Applied (all 7 stories) |
| 3 | Validate CI/CD E2E Pipeline | ✅ Completed (Story 7.7) |
| 4 | PDF Export UI Accessibility | ✅ Fixed (Story 7.1) |
| 5 | Capture Product Vision Document | ⏳ Partial (Three Moments Framework noted, no formal doc) |
| 6 | Increase SSG Chart Height | ✅ Fixed (Story 7.1) |
| 7 | Add Persistent Legend Below SSG Chart | ✅ Fixed (Story 7.1) |

**Result:** 6/7 completed, 1 in progress. Strong follow-through.

---

## Successes

- **Epic 6 action item follow-through:** 6/7 items completed — proves retrospectives drive real improvement
- **Code review process:** Caught real issues in every single story (test gaps, dead code, validation missing)
- **Append-only/immutability pattern:** Clean architectural contract established for all future snapshot work
- **CI/CD pipeline validated:** 23 E2E tests + 57 backend tests now running reliably in GitHub Actions
- **Exchange rate service:** Elegant 2-base-rate → 6-pair derivation with cache + DB fallback
- **Backend infrastructure:** Solid foundation for Epic 8 (snapshots, exchange rates, migrations)

---

## Challenges

- **CI debugging was painful:** Push-wait-read-fix cycle with no local reproduction. Trunk installation, stale cache hits, SPA routing all required multiple iterations.
- **CRITICAL BUG: Snapshot creation broken in real environments:** `POST /api/v1/snapshots` returns 500 — FK constraint on `user_id` fails because no default user is seeded in the `users` table. Locked theses cannot be saved. Library page is always empty.
- **Test-environment-only validation:** CI tests pass with seeded test data but real usage fails. Gap between test fixtures and production state.
- **"Built But Inaccessible" pattern recurring:** Features work at API level but break at user-flow level (same pattern flagged in Epic 6 retro).
- **MySQL/SeaORM/Loco framework friction:** `db::seed()` unsupported, no MEDIUMBLOB variant, no 403/503 error variants. Recurring tax across stories.

---

## Key Insights

1. **Snapshot creation is broken in real environments** — FK constraint on `user_id` fails because no default user is seeded. Must fix before Epic 8.
2. **Test-environment-only validation is insufficient** — CI tests pass with seeded data but real usage fails. DoD must include real-environment verification.
3. **Backend-heavy epics need different validation** — Manual UI testing doesn't surface API integration issues. Data persistence flows need explicit E2E coverage.
4. **CI/CD pipeline investment pays forward** — Painful to debug but every future push benefits.

---

## Action Items

### Process Improvements

1. **Add E2E test for lock-thesis-to-library flow**
   - Owner: Dana (QA Engineer)
   - Success criteria: E2E test that locks a thesis, navigates to Library, verifies snapshot card appears

2. **Add data persistence E2E tests alongside UI navigation tests**
   - Owner: Dana (QA Engineer)
   - Success criteria: At least one E2E test per epic that validates data round-trip (create → read back)

3. **Verify features in real environment, not just CI**
   - Owner: Team agreement
   - Success criteria: DoD checklist includes "verified in dev environment" for API-dependent features

### Technical Debt

1. **CRITICAL: Fix snapshot creation — seed default user in migration**
   - Owner: Charlie (Senior Dev)
   - Priority: BLOCKER — must fix before Epic 8
   - Description: Add default user (id=1) in migration so FK constraint on `analysis_snapshots.user_id` succeeds

2. **Loco Response::builder() boilerplate for 403/503**
   - Owner: Charlie (Senior Dev)
   - Priority: Low (accepted framework limitation)

### Documentation

1. **Product Vision Document** — carried forward from Epic 6 retro
   - Owner: Alice (Product Owner)

### Team Agreements

- Every story with API endpoints must be tested with a real request in dev environment, not only unit/integration tests
- E2E tests must cover at least one data flow per epic, not just UI element checks
- CI debugging findings documented in MEMORY.md for future reference

---

## Epic 8 Preparation

### Critical (before Epic 8 starts)

- [ ] Fix default user seeding — unblocks all snapshot creation
- [ ] Verify lock thesis → Library flow works end-to-end after fix

### Parallel (during early stories)

- [ ] Add lock-to-library E2E test to CI pipeline
- [ ] Review Epic 8 story definitions against actual snapshot API shape

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ⚠️ CI passes, real-environment snapshot creation broken |
| Deployment | ⚠️ Held in dev until snapshot bug fixed |
| Stakeholder Acceptance | ⚠️ Pending — blocked by snapshot bug |
| Technical Health | ✅ Codebase stable and maintainable |
| Unresolved Blockers | ⚠️ 1 critical: default user seeding |

**Verdict:** Epic 7 complete from story perspective. 1 critical fix required before production-ready and before Epic 8 can begin.

---

## Next Steps

1. Fix snapshot bug (seed default user)
2. Verify lock-thesis → Library flow end-to-end
3. Begin Epic 8 with `/bmad-bmm-create-story` for Story 8.1
